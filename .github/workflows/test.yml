name: Test & Build (Supabase)

on:
  push:
    branches: [ main, develop, feature/use-supabase-db ]
  pull_request:
    branches: [ main, develop ]

jobs:
  backend-test:
    name: Backend Tests (Supabase)
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [18.x, 20.x]
    
    env:
      NODE_ENV: test
      JWT_SECRET: test-secret-for-ci-only-min-32-chars-long-enough-for-jwt
      JWT_REFRESH_SECRET: test-refresh-secret-for-ci-only-min-32-chars-long
      # Supabase Test Database - Add as GitHub Secret
      DATABASE_URL: ${{ secrets.SUPABASE_TEST_DATABASE_URL }}
      SUPABASE_URL: ${{ secrets.SUPABASE_TEST_URL }}
      SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_TEST_SERVICE_KEY }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        cache-dependency-path: backend/package-lock.json
    
    - name: Install Backend Dependencies
      run: |
        cd backend
        npm ci
    
    - name: Check Supabase Connection
      run: |
        if [ -z "$DATABASE_URL" ]; then
          echo "⚠️  SUPABASE_TEST_DATABASE_URL not set - using mock mode"
          echo "   Add secret in GitHub Settings > Secrets and variables > Actions"
          echo "   Format: postgresql://postgres.[ref]:[pass]@aws-1-[region].pooler.supabase.com:6543/postgres"
        else
          echo "✅ Supabase test database configured"
        fi
    
    - name: Run Migrations (if Supabase configured)
      if: env.DATABASE_URL != ''
      run: |
        cd backend
        npm run db:migrate
    
    - name: Run Unit Tests
      run: |
        cd backend
        npm test -- --testPathIgnorePatterns=integration
    
    - name: Run Integration Tests
      if: env.DATABASE_URL != ''
      run: |
        cd backend
        npm test -- --testPathPattern=integration
    
    - name: Upload Coverage
      if: matrix.node-version == '20.x'
      uses: codecov/codecov-action@v3
      with:
        directory: ./backend/coverage
        flags: backend
        name: backend-${{ matrix.node-version }}

  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install Frontend Dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Run Frontend Tests (if available)
      run: |
        cd frontend
        if [ -f "package.json" ] && grep -q '"test"' package.json; then
          npm test || echo "⚠️  Frontend tests not yet configured"
        else
          echo "ℹ️  No frontend tests configured yet"
        fi
    
    - name: Build Frontend
      run: |
        cd frontend
        npm run build
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: frontend-dist
        path: frontend/dist
        retention-days: 7

  security-scan:
    name: Security Audit
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
    
    - name: Run npm audit (Backend)
      run: |
        cd backend
        npm audit --audit-level=high || echo "⚠️  Security issues found - review required"
    
    - name: Run npm audit (Frontend)
      run: |
        cd frontend
        npm audit --audit-level=high || echo "⚠️  Security issues found - review required"

  quick-check:
    name: Quick Check (Fallback)
    runs-on: ubuntu-latest
    if: ${{ !secrets.SUPABASE_TEST_DATABASE_URL }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18.x'
    
    - name: Verify Project Structure
      run: |
        echo "✅ Checking project structure..."
        ls -la
        echo "✅ Backend files:"
        ls -la backend/
        echo "✅ Frontend files:"
        ls -la frontend/
        echo "✅ Project structure verified!"
    
    - name: Configuration Notice
      run: |
        echo "ℹ️  =========================================="
        echo "ℹ️  Supabase Test Database Not Configured"
        echo "ℹ️  =========================================="
        echo ""
        echo "To enable full integration tests:"
        echo "1. Create a Supabase test project"
        echo "2. Add secrets in GitHub Settings > Secrets:"
        echo "   - SUPABASE_TEST_DATABASE_URL"
        echo "   - SUPABASE_TEST_URL"
        echo "   - SUPABASE_TEST_SERVICE_KEY"
        echo ""
        echo "Format for DATABASE_URL:"
        echo "postgresql://postgres.[ref]:[pass]@aws-1-[region].pooler.supabase.com:6543/postgres"
